# 设备模拟建议

**更新时间**：2025年6月2日
**作者**：Huangyijun

 

------

因为我们没有智能设备的api，因此我们需要模拟设备的运行模式与api操作。



**最新系统流程设计如下：**

设备控制流程：

前端发送控制请求->Device类调用设备控制api->设备修改自身状态

前端发送策略修改请求->DeviceMonitor类修改设备表的当前策略属性

设备持续控制流程：

DeviceMonitor定期查询设备表->若有策略查询策略表->根据策略调用设备控制api

设备监测流程：

DeviceMonitor类持续调用设备查询api->redis储存设备当前状态->定期将设备状态写入设备表

DeviceMonitor类轮询时生成日志条目->定期批量写入日志表。

设备查询流程：

前端定期查询设备状态->后端根据redis发回当前状态



以上均为异步的

此外要注意：

1.策略应该位于系统层面，由系统进行维护，设备本身不持有策略。

2.设备api中传输的应该是运行模式名，而不可能是数据库的运行模式id。同理，redis也只储存模式名



而考虑到我们没有设备api，这里的流程需要做出修改：

设备控制流程为：

前端发送控制请求->Device类调用模拟设备控制api->模拟api修改模拟设备表

前端发送策略修改请求->（不变）

设备监测流程为：

DeviceMonitor类持续调用模拟设备查询api->模拟api查询模拟设备表与模拟运行模式表->redis储存

->定期写入设备表









#### 0.设备运行模式模拟

认为设备具有运行状态（开/关机）。设备具有多种运行模式（具有不同的功率），不同设备的运行模式不同。



#### 1.设备初始信息查询

理论上，加入设备时，应该由系统查询设备api得到设备的模式、功率信息。

但这里为了简便，我建议内置几种不同类型的设备数据（例如空调、吊灯、洗衣机、电视机等），并内置对应的运行模式生成函数。

前端添加设备时只需要传入设备名称和类型即可，后端调用默认该类设备的生成函数，生成对应实体，并存入数据库





#### 2.当前状态查询

1.假设轮询设备时，设备只能返回瞬时的运行状态

2.设定轮询设备的粒度为1分钟（考虑到项目开发环境，避免挤爆数据库）

3.每次轮询后，认为设备在过去一分钟内按当前状态与功率运行。并计算出用电量。

4.储存设备日志的粒度也可以设定，例如5分钟，每5次轮询输出一次日志，记录为用电量相加，但设备状态取最后一次

5.实际生产环境中，时间粒度会小很多（例如5秒轮询30秒日志）





轮询函数：

查询设备状态，修改设备的状态属性（原子操作）

计算用电量并返回

若查询到异常模式，设为故障状态，调用警报生成函数（故障警告，短路严重警告）

（理论上，故障应该是多次查询但设备未响应，才能认定为故障，这里简化了）

若过去1周内用电量较高，生成对应的警报（预警）





#### 