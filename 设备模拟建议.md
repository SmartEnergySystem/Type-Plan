# 设备模拟建议

**更新时间**：2025年5月28日
**作者**：Huangyijun

 

------

因为我们没有智能设备的api，因此我们需要模拟设备的运行模式与api操作。



#### 0.设备运行模式模拟

认为设备具有运行状态（开/关机）。设备具有多种运行模式（具有不同的功率），不同设备的运行模式不同。

设备具有3个api：设备初始信息查询、当前状态查询、发送控制指令

可以建立DeviceApiCallingService类，编写上述模拟函数。



#### 1.设备初始信息查询

理论上，加入设备时，应该由系统查询设备api得到设备的模式、功率信息。

但这里为了简便，我建议内置几种不同类型的设备数据（例如空调、吊灯、洗衣机、电视机等），并内置对应的运行模式生成函数。

前端添加设备时只需要传入设备名称和类型即可，后端调用默认该类设备的生成函数，生成对应实体，并存入数据库





#### 2.当前状态查询

1.假设轮询设备时，设备只能返回瞬时的运行状态

2.设定轮询设备的粒度为1分钟（考虑到项目开发环境，避免挤爆数据库）

3.每次轮询后，认为设备在过去一分钟内按当前状态与功率运行。并计算出用电量。

4.储存设备日志的粒度也可以设定，例如5分钟，每5次轮询输出一次日志，记录为用电量相加，但设备状态取最后一次

5.实际生产环境中，时间粒度会小很多（例如5秒轮询30秒日志）





**设备状态查询（模拟）函数：**

检测设备是否具有当前策略，若没有，返回设备表中当前状态

若有当前策略，根据时间查询策略条目，处于条目则返回条目写的状态，否则返回关机状态





轮询函数：

查询设备状态，修改设备的状态属性（原子操作）

计算用电量并返回

若查询到异常模式，设为故障状态，调用警报生成函数（故障警告，短路严重警告）

（理论上，故障应该是多次查询但设备未响应，才能认定为故障，这里简化了）





日志周期函数：

重复轮询，直到记录一次日志





数据监测模块：

后端独立进程，为每个设备重复运行日志周期函数

考虑按设备并发



若过去1周内用电量较高，生成对应的警报（预警）





#### 3.发送控制指令（不进行模拟）

理论上，设备未必支持策略，而只能瞬时的改变运行状态。策略只是一个指导，系统根据策略给设备发布不同的控制指令。

或在系统中直接切换设备运行状态时，系统向设备发送控制指令。



但在本项目都省略。

为设备设定策略时，修改设备表的当前策略属性即可，认为设备正确按照策略运行

切换设备运行状态时，修改设备表的状态与模式属性即可，认为设备正确切换到对应状态（然后状态查询api返回这个状态）





此外，以上函数只是暂时设定，在后端类设计文档中会再次说明