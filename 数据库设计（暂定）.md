- - # 数据库设计（暂定）
  
    **更新时间**：2025年5月28日
    **作者**：Huangyijun
  
     
  
    ------
  
    备注：为了开发规范，以下均为逻辑外键而非物理外键！
  
    ## 1. 用户信息表user
  
    | 属性名称        | 数据类型    | 含义                 | 备注                 |
    | --------------- | ----------- | -------------------- | -------------------- |
    | **id**          | bigint      | 用户id               | 主键、自增           |
    | **username**    | varchar(32) | 用户名               | 唯一                 |
    | **password**    | varchar(64) | 密码                 | 需要加密储存         |
    | **status**      | int         | 用户状态             | 0=禁用，1=启用       |
    | **type**        | int         | 用户类型（权限级别） | 0=普通用户，1=管理员 |
    | **createtime**  | datetime    | 创建时间             |                      |
    | **updatetime**  | datetime    | 最后修改时间         |                      |
    | **create_user** | bigint      | 创建人id             |                      |
    | **update_user** | bigint      | 最后修改人id         |                      |
    
  
    
  ## 2. 设备表device
    
    | 属性名称            | 数据类型    | 含义         | 备注                          |
    | ------------------- | ----------- | ------------ | ----------------------------- |
    | **id**              | bigint      | 设备id       | 主键、自增                    |
    | **user_id**         | bigint      | 用户id       | 外键                          |
    | **name**            | varchar(32) | 设备名称     | 唯一                          |
    | **status**          | int         | 运行状态     | 0=关闭，1=开启，-1=异常或损坏 |
    | **mode_id**         | bigint      | 当前运行模式 | 外键                          |
    | **default_mode_id** | bigint      | 默认运行模式 | 外键开启设备时默认选用的模式  |
    | **policy****_id**   | bigint      | 当前运行策略 | 外键可以为空                  |
    
    
    
    ## 3. 设备运行模式表device_**mode**
    
    | 属性名称      | 数据类型    | 含义         | 备注       |
    | ------------- | ----------- | ------------ | ---------- |
    | **id**        | bigint      | 运行模式id   | 主键、自增 |
    | **device_id** | bigint      | 设备id       | 外键       |
    | **name**      | varchar(32) | 运行模式名称 | 唯一       |
    | **power**     | int         | 该模式下功率 | 单位：W    |
    
    备注：添加设备时，会自动补充几种“故障”模式，用于调试，例如包括：
    
    1，name=“短路“，power=100000（模拟用电量过高）
    
    2，name=“故障“，power=0（模拟设备未响应）
    
    
    
    ## 4. 设备运行日志表device_**data**
    
    | 属性名称               | 数据类型 | 含义               | 备注                          |
    | ---------------------- | -------- | ------------------ | ----------------------------- |
    | **id**                 | bigint   | 运行日志id         | 主键、自增                    |
    | **device_id**          | bigint   | 设备id             | 外键                          |
    | **start_time**         | datetime | 开始时间           | 一般为上一次轮询的时间        |
    | **end_time**           | datetime | 结束时间           | 一般为本次轮询的时间          |
    | **status**             | int      | 该时间段的运行状态 | 0=关闭，1=开启，-1=异常或损坏 |
    | **mode_id**            | bigint   | 该时间段的运行模式 | 外键                          |
    | **policy_id**          | bigint   | 该时间段的运行策略 | 外键可以为空                  |
    | **energy_consumption** | int      | 用电量             | 单位：kWh                     |
    
    
    
    ## 5. 策略表**policy**
    
    | 属性名称       | 数据类型    | 含义         | 备注       |
    | -------------- | ----------- | ------------ | ---------- |
    | **id**         | bigint      | 策略id       | 主键、自增 |
    | **device_id**  | bigint      | 设备id       | 外键       |
    | **name**       | varchar(32) | 策略名称     | 唯一       |
    | **createtime** | datetime    | 创建时间     |            |
    | **updatetime** | datetime    | 最后修改时间 |            |
    
    
    
    ## 6. 策略条目表**policy_item**
    
    每个策略包含多个条目，每个条目指定设备在一定时间段内以特定运行模式运行。
    
    在没有条目的时间范围，设备处于关闭状态。
    
    条目的时间范围不能重叠，不能小于0点或大于24点。
    
    | 属性名称       | 数据类型 | 含义               | 备注       |
    | -------------- | -------- | ------------------ | ---------- |
    | **id**         | bigint   | 策略条目id         | 主键、自增 |
    | **policy_id**  | bigint   | 策略id             | 外键       |
    | **start_time** | datetime | 开始时间           |            |
    | **end_time**   | datetime | 结束时间           |            |
    | **mode_id**    | bigint   | 该时间段的运行模式 | 外键       |
    
    
    
    ## 7. 设备-策略表device_**policy**
    
    用于将策略附加给设备
    
    | 属性名称       | 数据类型 | 含义        | 备注       |
    | -------------- | -------- | ----------- | ---------- |
    | **id**         | bigint   | 设备-策略id | 主键、自增 |
    | **device_id**  | bigint   | 设备id      | 外键       |
    | **policy_id**  | bigint   | 策略id      | 外键       |
    | **createtime** | datetime | 创建时间    |            |
    
    备注：我后来想了想，设备是可以没有策略的（起码在数据库中，表现为设备没有被附加策略），修改设备本身的状态和模式属性足以操作设备。
    
    理论上我们应该：
    
    在设备控制中开启或关闭设备、调整运行模式时，使用api向设备发送控制信息
    
    在为设备附加或更换策略时，使用api向设备发送策略
    
    但是在本次项目中都省略
    
    
    
    ## 8. 批量操作表batch
    
    | 属性名称       | 数据类型    | 含义         | 备注       |
    | -------------- | ----------- | ------------ | ---------- |
    | **id**         | bigint      | 批量操作id   | 主键、自增 |
    | **user_id**    | bigint      | 用户id       | 外键       |
    | **name**       | varchar(32) | 批量操作名称 | 唯一       |
    | **createtime** | datetime    | 创建时间     |            |
    | **updatetime** | datetime    | 最后修改时间 |            |
    
    
    
    ## 9. 批量操作条目表batch**_item**
    
    | 属性名称      | 数据类型 | 含义               | 备注                                      |
    | ------------- | -------- | ------------------ | ----------------------------------------- |
    | **id**        | bigint   | 批量操作条目id     | 主键、自增                                |
    | **batch_id**  | bigint   | 批量操作id         | 外键                                      |
    | **device_id** | bigint   | 设备id             | 外键                                      |
    | **type**      | int      | 操作类型           | 0=直接切换到特定运行状态+模式1=切换到策略 |
    | **status**    | int      | 要切换到的运行状态 | 可以为空                                  |
    | **mode_id**   | bigint   | 要切换到的运行模式 | 外键可以为空                              |
    | **policy_id** | bigint   | 要切换到的策略     | 外键可以为空                              |
    
    
    
    ## 10. 警报日志表alert_data
    
    | 属性名称      | 数据类型     | 含义                 | 备注                          |
    | ------------- | ------------ | -------------------- | ----------------------------- |
    | **id**        | bigint       | 警报日志id           | 主键、自增                    |
    | **device_id** | bigint       | 设备id               | 外键                          |
    | **time**      | datetime     | 警报时间             |                               |
    | **level**     | int          | 警报级别             | 0=预警1=警告2=严重警告        |
    | **status**    | int          | 警报时设备的运行状态 | 0=关闭，1=开启，-1=异常或损坏 |
    | **mode_id**   | bigint       | 警报时设备的运行模式 | 外键                          |
    | **policy_id** | bigint       | 警报时设备的运行策略 | 外键可以为空                  |
    | **message**   | varchar(200) | 警报信息             |                               |
