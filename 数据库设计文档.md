- - # 数据库设计文档
  
    **更新时间**：2025年6月10日
    **作者**：Huangyijun
  
     
  
    ------
  
    备注：为了开发规范，以下均为逻辑外键而非物理外键！
  
    ## 1. 用户信息表user
  
    | 属性名称        | 数据类型    | 含义                 | 备注                 |
    | --------------- | ----------- | -------------------- | -------------------- |
    | **id**          | bigint      | 用户id               | 主键、自增           |
    | **username**    | varchar(32) | 用户名               | 唯一                 |
    | **password**    | varchar(64) | 密码                 | 需要加密储存         |
    | **status**      | int         | 用户状态             | 0=禁用，1=启用       |
    | **type**        | int         | 用户类型（权限级别） | 0=普通用户，1=管理员 |
    | **createtime**  | datetime    | 创建时间             |                      |
    | **updatetime**  | datetime    | 最后修改时间         |                      |
    | **create_user** | bigint      | 创建人id             |                      |
    | **update_user** | bigint      | 最后修改人id         |                      |
  
    
  
    ## 2. 设备表device
  
    | 属性名称               | 数据类型    | 含义               | 备注                                    |
    | ---------------------- | ----------- | ------------------ | --------------------------------------- |
    | **id**                 | bigint      | 设备id             | 主键、自增                              |
    | **user_id**            | bigint      | 用户id             | 外键                                    |
    | **name**               | varchar(32) | 设备名称           |                                         |
    | **last_known_status**  | int         | 最后已知运行状态   | （已弃用）0=关闭，1=开启，-1=异常或损坏 |
    | **last_known_mode_id** | bigint      | 最后已知运行模式   | （已弃用）外键                          |
    | **default_mode_name**  | bigint      | 默认运行模式名     | 外键开启设备时默认选用的模式            |
    | **policy****_id**      | bigint      | 当前应用的运行策略 | 外键可以为空                            |
  
    
  
    ## 3. 设备运行模式表device_**mode**
  
    | 属性名称      | 数据类型    | 含义         | 备注         |
    | ------------- | ----------- | ------------ | ------------ |
    | **id**        | bigint      | 运行模式id   | 主键、自增   |
    | **device_id** | bigint      | 设备id       | 外键         |
    | **name**      | varchar(32) | 运行模式名称 | 同设备内唯一 |
  
    
  
    ## 4. 策略表**policy**
  
    策略属于设备，一个设备可以定义多个策略
    
    设备使用“当前策略id”的属性来应用策略
    
    设备可以不应用策略，但一定处于某个状态+模式（如果开启）
    
    （详见“设备模拟建议”）
    
    | 属性名称       | 数据类型    | 含义         | 备注       |
    | -------------- | ----------- | ------------ | ---------- |
  | **id**         | bigint      | 策略id       | 主键、自增 |
    | **device_id**  | bigint      | 设备id       | 外键       |
  | **name**       | varchar(32) | 策略名称     |            |
    | **createtime** | datetime    | 创建时间     |            |
  | **updatetime** | datetime    | 最后修改时间 |            |
    
  
    
    ## 5. 策略条目表**policy_item**
    
    每个策略包含多个条目，每个条目指定设备在一定时间段内以特定运行模式运行。
    
    在没有条目的时间范围，设备处于关闭状态。
    
    条目的时间范围不能重叠，不能小于0点或大于24点。
    
    | 属性名称          | 数据类型 | 含义               | 备注       |
    | ----------------- | -------- | ------------------ | ---------- |
    | **id**            | bigint   | 策略条目id         | 主键、自增 |
    | **policy****_id** | bigint   | 策略id             | 外键       |
    | **start_time**    | datetime | 开始时间           |            |
    | **end_time**      | datetime | 结束时间           |            |
    | **mode_id**       | bigint   | 该时间段的运行模式 | 外键       |
    
    
    
    ## 6. 批量操作表batch
    
    | 属性名称       | 数据类型    | 含义         | 备注       |
    | -------------- | ----------- | ------------ | ---------- |
    | **id**         | bigint      | 批量操作id   | 主键、自增 |
    | **user_id**    | bigint      | 用户id       | 外键       |
    | **name**       | varchar(32) | 批量操作名称 |            |
    | **createtime** | datetime    | 创建时间     |            |
    | **updatetime** | datetime    | 最后修改时间 |            |
    
    
    
    ## 7. 批量操作条目表batch**_item**
    
    | 属性名称          | 数据类型 | 含义               | 备注                                                    |
    | ----------------- | -------- | ------------------ | ------------------------------------------------------- |
    | **id**            | bigint   | 批量操作条目id     | 主键、自增                                              |
    | **batch_id**      | bigint   | 批量操作id         | 外键                                                    |
    | **device_id**     | bigint   | 设备id             | 外键                                                    |
    | **isApplyPolicy** | int      | 是否修改策略       | 可以为空0=表示解绑策略1=表示应用policyIdNULL=不修改策略 |
    | **status**        | int      | 要切换到的运行状态 | 可以为空                                                |
    | **mode_id**       | bigint   | 要切换到的运行模式 | 外键可以为空                                            |
    | **policy****_id** | bigint   | 要应用的策略       | 外键可以为空                                            |
    
    
    
    ## 8. 设备运行日志表device_**log**
    
    | 属性名称               | 数据类型    | 含义                 | 备注                          |
    | ---------------------- | ----------- | -------------------- | ----------------------------- |
    | **id**                 | bigint      | 运行日志id           | 主键、自增                    |
    | **user_id**            | bigint      | 用户id               | 外键                          |
    | **user_username**      | varchar(32) | 用户名称             | 冗余信息                      |
    | **device_id**          | bigint      | 设备id               | 外键                          |
    | **device_name**        | varchar(32) | 设备名称             | 冗余信息                      |
    | **start_time**         | datetime    | 开始时间             | 一般为上一次轮询的时间        |
    | **end_time**           | datetime    | 结束时间             | 一般为本次轮询的时间          |
    | **status**             | int         | 该时间段的运行状态   | 0=关闭，1=开启，-1=异常或损坏 |
    | **mode_name**          | varchar(32) | 该时间段的运行模式名 |                               |
    | **policy****_name**    | varchar(32) | 该时间段的运行策略名 | 可以为空                      |
    | **policy**             | JSON        | 策略的具体内容       | 可以为空冗余信息              |
    | **power**              | float       | 该时间段的功率       | 单位：W                       |
    | **energy_consumption** | float       | 该时间段的用电量     | 单位：Wh                      |
    
    用户名和设备名的冗余信息保证，当用户或设备被改名或删除，日志仍能保持当时的有效信息。
    
    策略由于数据结构复杂，使用JSON储存。不使用策略id的原因是，日志一旦生成，不应该依赖外部信息。
    
    
    
    ## 9. 警报日志表alert_log
    
    | 属性名称            | 数据类型     | 含义                   | 备注                          |
    | ------------------- | ------------ | ---------------------- | ----------------------------- |
    | **id**              | bigint       | 警报日志id             | 主键、自增                    |
    | **user_id**         | bigint       | 用户id                 | 外键                          |
    | **user_username**   | varchar(32)  | 用户名称               | 冗余信息                      |
    | **device_id**       | bigint       | 设备id                 | 外键                          |
    | **device_name**     | varchar(32)  | 设备名称               | 冗余信息                      |
    | **time**            | datetime     | 警报时间               |                               |
    | **level**           | int          | 警报级别               | 0=预警1=警告2=严重警告        |
    | **status**          | int          | 警报时设备的运行状态   | 0=关闭，1=开启，-1=异常或损坏 |
    | **mode_name**       | bigint       | 警报时设备的运行模式名 |                               |
    | **policy****_name** | varchar(32)  | 警报时设备的运行策略名 | 可以为空                      |
    | **policy**          | JSON         | 策略的具体内容         | 可以为空                      |
    | **message**         | varchar(200) | 警报信息               |                               |
    
    
    
    ## 10. 操作日志表operation_log
    
    记录对设备的操作，包括修改策略和发送控制请求
    
    | 属性名称            | 数据类型    | 含义                               | 备注             |
    | ------------------- | ----------- | ---------------------------------- | ---------------- |
    | **id**              | bigint      | 警报日志id                         | 主键、自增       |
    | **user_id**         | bigint      | 用户id                             | 外键             |
    | **user_username**   | varchar(32) | 用户名称                           | 冗余信息         |
    | **device_id**       | bigint      | 设备id                             | 外键             |
    | **device_name**     | varchar(32) | 设备名称                           | 冗余信息         |
    | **time**            | datetime    | 操作发生时间                       |                  |
    | **isApplyPolicy**   | int         | 是否修改策略                       | 可以为空         |
    | **status**          | int         | 切换到的运行状态                   | 可以为空         |
    | **mode_name**       | varchar(32) | 切换到的运行模式                   | 可以为空         |
    | **policy****_name** | varchar(32) | 应用的策略名                       | 可以为空         |
    | **policy**          | JSON        | 策略的具体内容                     | 可以为空冗余信息 |
    | **batch_name**      | varchar(32) | 若属于批量操作，对应批量操作的名称 | 可以为空         |
    
    
    
    ## 11. 模拟设备表sim_device
    
    用于模拟设备api，外键指向原设备
    
    | 属性名称      | 数据类型    | 含义             | 备注                          |
    | ------------- | ----------- | ---------------- | ----------------------------- |
    | **id**        | bigint      | 模拟设备id       | 主键、自增                    |
    | **device_id** | bigint      | 设备id           | 外键                          |
    | **status**    | int         | 当前运行状态     | 0=关闭，1=开启，-1=异常或损坏 |
    | **mode_name** | varchar(32) | 当前运行模式名称 | 对应该设备的模式表            |
    
    ## 12. 模拟设备运行模式表sim_device_**mode**
    
    理论上，运行模式不可能有固定功率信息，数据库也不可能储存功率。这里的功率只用于模拟api的用电量计算
    
    | 属性名称      | 数据类型    | 含义         | 备注         |
    | ------------- | ----------- | ------------ | ------------ |
    | **id**        | bigint      | 运行模式id   | 主键、自增   |
    | **device_id** | bigint      | 设备id       | 外键         |
    | **name**      | varchar(32) | 运行模式名称 | 同设备内唯一 |
    | **power**     | float       | 该模式下功率 | 单位：W      |
    
    备注：后端内置的几种模拟设备中，都会包含一些“故障”模式，用于调试，例如包括：
    
    1，name=“短路“，power=9999（模拟用电量过高）
    
    2，name=“故障“，power=0（模拟设备未响应）
